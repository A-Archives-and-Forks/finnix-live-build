#!/bin/sh

# SPDX-PackageSummary: finnix-live-build
# SPDX-FileComment: cmdline-passwd chroot hook
# SPDX-FileCopyrightText: Copyright (C) 2020-2021 Ryan Finnie
# SPDX-License-Identifier: MPL-2.0

set -e

PRODUCT_ID="{{ PRODUCT_ID }}"

install -D -m 0755 /hook-files/cmdline-passwd "/usr/lib/${PRODUCT_ID}/cmdline-passwd"

cat <<"EOM" >/etc/systemd/system/cmdline-passwd.service
[Unit]
Description=Change passwords from command line
ConditionKernelCommandLine=|passwd
ConditionKernelCommandLine=|sshd_password

[Service]
Type=oneshot
ExecStart=/usr/lib/{{ PRODUCT_ID }}/cmdline-passwd
EOM
systemctl add-wants "${PRODUCT_ID}.target" cmdline-passwd.service
