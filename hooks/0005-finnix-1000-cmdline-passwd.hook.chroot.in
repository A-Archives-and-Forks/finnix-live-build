#!/bin/sh

# cmdline-passwd chroot hook
# Copyright (C) 2020-2021 Ryan Finnie
# SPDX-License-Identifier: GPL-2.0+

set -e

PRODUCT_ID="{{ PRODUCT_ID }}"

mkdir -p "/lib/${PRODUCT_ID}"
cp /hook-files/cmdline-passwd "/lib/${PRODUCT_ID}/cmdline-passwd"
chmod 0755 "/lib/${PRODUCT_ID}/cmdline-passwd"

cat <<"EOM" >/etc/systemd/system/cmdline-passwd.service
[Unit]
Description=Change passwords from command line
ConditionKernelCommandLine=passwd

[Service]
Type=oneshot
ExecStart=/lib/{{ PRODUCT_ID }}/cmdline-passwd
EOM
systemctl add-wants "${PRODUCT_ID}.target" cmdline-passwd.service
