#!/bin/sh

# network chroot hook
# Copyright (C) 2020-2021 Ryan Finnie
# SPDX-License-Identifier: GPL-2.0+

set -e

PRODUCT_ID="{{ PRODUCT_ID }}"

mkdir -p "/lib/${PRODUCT_ID}"
cp /hook-files/interfaces-convert "/lib/${PRODUCT_ID}/interfaces-convert"
chmod 0755 "/lib/${PRODUCT_ID}/interfaces-convert"

cat <<"EOM" >/etc/systemd/system/network-config-setup.service
[Unit]
Description=Set up network configurations
DefaultDependencies=no
# Before systemd-udevd becuase ifupdown will try to manage hotplug
# interfaces via udev
Before=network.target ifupdown-pre.service systemd-udevd.service

[Service]
Type=oneshot
ExecStart=/lib/{{ PRODUCT_ID }}/interfaces-convert
EOM
systemctl add-wants sysinit.target network-config-setup.service
systemctl add-wants network.target systemd-networkd.service
systemctl add-wants network.target systemd-resolved.service

systemctl add-wants "${PRODUCT_ID}.target" network.target
