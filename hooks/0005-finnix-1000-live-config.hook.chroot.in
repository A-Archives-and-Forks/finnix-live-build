#!/bin/sh

# SPDX-PackageSummary: finnix-live-build
# SPDX-FileComment: live-config chroot hook
# SPDX-FileCopyrightText: Copyright (C) 2020-2021 Ryan Finnie
# SPDX-License-Identifier: MPL-2.0

# Replicate much of what we used live-config for at build time.
# Note that to avoid installing live-config itself,
# lists/live.list.chroot must exist and be installed to
# config/package-lists/live.list.chroot .

set -e

PRODUCT_ID="{{ PRODUCT_ID }}"

systemctl add-wants "${PRODUCT_ID}.target" live-tools.service

useradd \
    --create-home \
    --comment "{{ PRODUCT }} user" \
    --password '*' \
    --shell /bin/bash \
    --groups audio,cdrom,dip,floppy,video,plugdev,adm,sudo \
    "${PRODUCT_ID}"

mkdir -p /etc/sudoers.d
cat <<EOM >"/etc/sudoers.d/${PRODUCT_ID}"
{{ PRODUCT_ID }} ALL=(ALL) NOPASSWD: ALL
EOM
chmod 0440 "/etc/sudoers.d/${PRODUCT_ID}"

echo 'Etc/UTC' >/etc/timezone
rm -f /etc/localtime
dpkg-reconfigure -f noninteractive -p critical tzdata
