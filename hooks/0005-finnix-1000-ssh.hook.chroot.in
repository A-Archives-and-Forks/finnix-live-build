#!/bin/sh

set -e

PRODUCT_ID="{{ PRODUCT_ID }}"

mkdir -p "/lib/${PRODUCT_ID}"
cp /hook-files/sshd-keygen "/lib/${PRODUCT_ID}/sshd-keygen"
chmod 0755 "/lib/${PRODUCT_ID}/sshd-keygen"

mkdir -p /etc/systemd/system/ssh.service.d
cat <<"EOM" >"/etc/systemd/system/ssh.service.d/${PRODUCT_ID}.conf"
[Service]
ExecStartPre=
ExecStartPre=/lib/{{ PRODUCT_ID }}/sshd-keygen
ExecStartPre=/usr/sbin/sshd -t
EOM

cat <<"EOM" >"/etc/ssh/sshd_config.d/${PRODUCT_ID}.conf"
# "Safe" for maintenance use since by default, the user needs to set a
# root password and start ssh.service.
PasswordAuthentication yes
PermitRootLogin yes
EOM

# Shared per-user SSH agent
mkdir -p "/lib/${PRODUCT_ID}"
cp /hook-files/ssh-agent "/lib/${PRODUCT_ID}/ssh-agent"
chmod 0755 "/lib/${PRODUCT_ID}/ssh-agent"

cat <<"EOM" >/etc/systemd/system/shared-ssh-agent.service
[Unit]
Description=Shared SSH agent init
Before=getty.target

[Service]
Type=forking
ExecStart=/lib/{{ PRODUCT_ID }}/ssh-agent
PIDFile=/root/.ssh/ssh-agent.pid
Environment="USER=root"
Environment="HOME=/root"
EOM
systemctl add-wants "${PRODUCT_ID}.target" shared-ssh-agent.service

cat <<"EOM" >/etc/systemd/system/cmdline-sshd.service
[Unit]
Description=Kernel command line SSH daemon
After=network.target
ConditionKernelCommandLine=sshd

[Service]
Type=oneshot
ExecStart=systemctl --no-block start ssh.service
EOM
systemctl add-wants "${PRODUCT_ID}.target" cmdline-sshd.service
