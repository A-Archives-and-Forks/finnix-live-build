#!/bin/sh

set -e

# Requires: LIVE_CONFIG_NOCOMPONENTS="openssh-server"
mkdir -p /etc/systemd/system/ssh.service.d
cat <<"EOM" >/etc/systemd/system/ssh.service.d/{{ PRODUCT_ID }}.conf
[Service]
ExecStartPre=
ExecStartPre=/bin/sh -c /lib/live/config/????-openssh-server
ExecStartPre=/usr/sbin/sshd -t
EOM

cat <<"EOM" >/etc/ssh/sshd_config.d/{{ PRODUCT_ID }}.conf
# "Safe" for maintenance use since by default, the user needs to set a
# root password and start ssh.service.
PasswordAuthentication yes
PermitRootLogin yes
EOM

# Shared per-user SSH agent
mkdir -p /lib/{{ PRODUCT_ID }}
cat <<"EOM" >/lib/{{ PRODUCT_ID }}/ssh-agent
#!/bin/sh

[ -n "${HOME}" ] || exit 1

if [ ! -e "${HOME}/.ssh/ssh-agent.sh" ]; then
    mkdir -p "${HOME}/.ssh"
    ssh-agent -s | grep ^SSH >"${HOME}/.ssh/ssh-agent.sh"
    . "${HOME}/.ssh/ssh-agent.sh"
    echo "${SSH_AGENT_PID}" >"${HOME}/.ssh/ssh-agent.pid"
fi
. "${HOME}/.ssh/ssh-agent.sh"
EOM
chmod 0755 /lib/{{ PRODUCT_ID }}/ssh-agent

cat <<"EOM" >/etc/systemd/system/{{ PRODUCT_ID }}-ssh-agent.service
[Unit]
Description={{ PRODUCT }} SSH agent init
Before=getty.target

[Service]
Type=forking
ExecStart=/lib/{{ PRODUCT_ID }}/ssh-agent
PIDFile=/root/.ssh/ssh-agent.pid
Environment="USER=root"
Environment="HOME=/root"
EOM
systemctl add-wants {{ PRODUCT_ID }}.target {{ PRODUCT_ID }}-ssh-agent.service
